@*
 * Copyright 2025 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import models.report._
@import utils.ReportHelpers

@this(
  layout: templates.Layout,
  govukTabs: GovukTabs,
  govukTable: GovukTable
)

@(requestedReports: RequestedReportsViewModel,
  maybeUserReports: Boolean,
  maybeThirdPartyReports: Boolean
)(implicit request: Request[_], messages: Messages)

@userReportsContent = {
  @requestedReports.availableUserReports.map { reports =>
    <div class="tre-table-container" tabindex="0" role="region" aria-label="@messages("requestedReports.myReports")" aria-describedby="user-reports-scroll-hint">
      <div id="user-reports-scroll-hint" class="govuk-visually-hidden">@messages("requestedReports.myReports")</div>
      @govukTable(Table(
        head = Some(Seq(
          HeadCell(content = Text(messages("requestedReports.table.reportName"))),
          HeadCell(content = Text(messages("requestedReports.table.referenceNumber"))),
          HeadCell(content = Text(messages("requestedReports.table.reportType"))),
          HeadCell(content = Text(messages("requestedReports.table.requestedDate"))),
          HeadCell(content = Text(messages("requestedReports.table.status")))
        )),
      rows = reports.map { data =>
      val displayData = ReportHelpers.reportStatusDisplayData(data.reportStatus, data.reportName, data.referenceNumber, data.formattedReportStartDate.toString, data.formattedReportEndDate.toString)
      Seq(
        TableRow(content = Text(messages(data.reportName))),
        TableRow(content = Text(messages(data.referenceNumber))),
        TableRow(content = Text(messages(data.formattedReportType))),
        TableRow(content = Text(messages(data.formattedRequestedDate))),
        TableRow(content = HtmlContent {
          displayData.maybeRedirect match {
            case Some(redirect) =>
              s"""<a href="$redirect" class="govuk-link govuk-link--no-visited-state">${messages(displayData.key)}</a>"""
            case None =>
              s"""<span class="govuk-tag ${displayData.cssClass}">${messages(displayData.key)}</span>"""
          }
        })
      )
    },
        caption = Some(messages("requestedReports.myReports")),
        captionClasses = "govuk-table__caption--l"
      ))
    </div>
  }
}

@thirdPartyReportsContent = {
  <div class="tre-table-container" tabindex="0" role="region" aria-label="@messages("requestedReports.thirdPartyReports")" aria-describedby="third-party-reports-scroll-hint">
    <div id="third-party-reports-scroll-hint" class="govuk-visually-hidden">@messages("requestedReports.scrollHint")</div>
    @govukTable(Table(
      head = Some(Seq(
        HeadCell(content = Text(messages("requestedReports.table.reportName"))),
        HeadCell(content = Text(messages("requestedReports.table.referenceNumber"))),
        HeadCell(content = Text(messages("requestedReports.table.businessInfo"))),
        HeadCell(content = Text(messages("requestedReports.table.reportType"))),
        HeadCell(content = Text(messages("requestedReports.table.requestedDate"))),
        HeadCell(content = Text(messages("requestedReports.table.status")))
      )),
    rows = requestedReports.availableThirdPartyReports.getOrElse(Seq.empty).map { data =>
      val displayData = ReportHelpers.reportStatusDisplayData(data.reportStatus, data.reportName, data.referenceNumber, data.formattedReportStartDate.toString, data.formattedReportEndDate.toString)
      Seq(
        TableRow(content = Text(messages(data.reportName))),
        TableRow(content = Text(messages(data.referenceNumber))),
        TableRow(content = Text(if (data.companyName == "Unknown") messages("requestedReports.table.unknownCompany") else messages(data.companyName))),
        TableRow(content = Text(messages(data.formattedReportType))),
        TableRow(content = Text(messages(data.formattedRequestedDate))),
        TableRow(content = HtmlContent {
          displayData.maybeRedirect match {
            case Some(redirect) =>
              s"""<a href="$redirect" class="govuk-link govuk-link--no-visited-state">${messages(displayData.key)}</a>"""
            case None =>
              s"""<span class="govuk-tag ${displayData.cssClass}">${messages(displayData.key)}</span>"""
          }
        })
      )
      },
      caption = Some(messages("requestedReports.thirdPartyReports")),
      captionClasses = "govuk-table__caption--l"
    ))
  </div>
}


@layout(
  pageTitle = titleNoForm(messages("requestedReports.title")),
  breadcrumbContribution = Seq(
    BreadcrumbsItem(content = Text(messages("requestedReports.title")), href = Some(s"#"))
  ),
  showBackLink = false,
  isFullWidth = true
) {

  @if(maybeUserReports || maybeThirdPartyReports) {
  <h1 class="govuk-heading-xl">@messages("requestedReports.heading")</h1>
  <p class="govuk-body">
   @messages("requestedReports.message1")
   <a href="@controllers.routes.AvailableReportsController.onPageLoad().url"
      class="govuk-link govuk-link--no-visited-state">
    @messages("requestedReports.link1")
   </a>.
  </p>
  } else {
  <h1 class="govuk-heading-xl">@messages("requestedReports.heading")</h1>
    <p class="govuk-body">@messages("requestedReports.message2")</p>
    <ul class="govuk-list--spaced govuk-list--bullet">
        <li class="govuk-body">
            <a href="@controllers.routes.AvailableReportsController.onPageLoad().url" class="govuk-link">
            @messages("requestedReports.bullet1.none")
        </a>
        </li>
        <li class="govuk-body">
            <a href="@controllers.report.routes.ReportGuidanceController.onPageLoad().url" class="govuk-link">
            @messages("requestedReports.bullet2.none")
            </a>
        </li>
    </ul>

  <p class="govuk-body">
   <a href="@routes.DashboardController.onPageLoad().url" class="govuk-link">
    @messages("requestedReports.home.link")
   </a>
  </p>
}

@if(maybeUserReports && maybeThirdPartyReports) {
  @govukTabs(Tabs(
    items = Seq(
      TabItem(
        id = Some("my-reports"),
        label = "My reports",
        panel = TabPanel(content = HtmlContent(userReportsContent))
    ),
      TabItem(
        id = Some("third-party-reports"),
        label = "Third party reports",
        panel = TabPanel(content = HtmlContent(thirdPartyReportsContent))
      )
    )
  ))
}

@if(maybeUserReports && !maybeThirdPartyReports) {
  @userReportsContent
}

@if(!maybeUserReports && maybeThirdPartyReports) {
  @thirdPartyReportsContent
}
}
